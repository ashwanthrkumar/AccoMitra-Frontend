<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AccoMitra | Sign Up</title>

    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />
    <link href="https://cdn.lineicons.com/4.0/lineicons.css" rel="stylesheet" />

    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #f0f4ff, #dce1ff);
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 0;
        }

        .signup-container {
            background: white;
            border-radius: 16px;
            box-shadow: 0 6px 25px rgba(0, 0, 0, 0.1);
            width: 400px;
            padding: 2rem;
            text-align: center;
        }

        h1 {
            font-size: 1.8rem;
            color: #2a2a72;
            margin-bottom: 0.3rem;
        }

        p {
            color: #555;
            margin-bottom: 1.5rem;
        }

        .form-group {
            text-align: left;
            margin-bottom: 1rem;
        }

        label {
            font-weight: 500;
            display: block;
            margin-bottom: 5px;
        }

        input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 8px;
            font-size: 0.95rem;
        }

        .signup-button {
            width: 100%;
            padding: 12px;
            margin-top: 10px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: 0.3s;
        }

        .btn-email {
            background-color: #2a2a72;
            color: white;
        }

        .btn-email:hover {
            background-color: #23235b;
        }

        .btn-google {
            background-color: white;
            color: #444;
            border: 1px solid #ddd;
        }

        .btn-google:hover {
            background-color: #f7f7f7;
        }

        .divider {
            margin: 15px 0;
            display: flex;
            align-items: center;
            text-align: center;
        }

        .divider::before,
        .divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: #ddd;
        }

        .divider span {
            padding: 0 10px;
            font-size: 0.9rem;
            color: #777;
        }

        .error-message,
        .success-message {
            padding: 8px 10px;
            border-radius: 8px;
            margin-bottom: 10px;
            display: none;
            font-size: 0.9rem;
        }

        .error-message {
            background-color: #ffe5e5;
            color: #b00020;
        }

        .success-message {
            background-color: #e8f5e9;
            color: #2e7d32;
        }
    </style>
</head>

<body>
    <div class="signup-container">
        <h1>Create Your Account</h1>
        <p>Join AccoMitra to connect with trusted accountants</p>

        <div id="errorMessage" class="error-message"></div>
        <div id="successMessage" class="success-message"></div>

        <!-- Signup Form -->
        <form id="emailSignupForm">
            <div class="form-group">
                <label>Full Name</label>
                <input type="text" id="signupName" required />
            </div>
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="signupEmail" required />
            </div>
            <div class="form-group">
                <label>Password</label>
                <input type="password" id="signupPassword" required minlength="6" />
            </div>
            <div class="form-group">
                <label>Confirm Password</label>
                <input type="password" id="confirmPassword" required />
            </div>
            <button type="submit" class="signup-button btn-email">Create Account</button>
        </form>

        <div class="divider"><span>OR</span></div>
        <button id="googleSignup" class="signup-button btn-google">
            <i class="lni lni-google"></i> Sign up with Google
        </button>

        <p style="margin-top: 1rem; font-size: 0.9rem;">
            Already have an account? <a href="login.html" style="color: #2a2a72; text-decoration: none;">Sign In</a>
        </p>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import {
            getAuth,
            GoogleAuthProvider,
            createUserWithEmailAndPassword,
            signInWithPopup,
            updateProfile,
        } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

        // ðŸ”¹ Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyD5Rda8GzjQhbegWPcT6Q-atfbmpb6enc4",
            authDomain: "accomitra-477605.firebaseapp.com",
            projectId: "accomitra-477605",
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();

        // ðŸ”¹ UI helper functions
        const showMessage = (msg, color = "#1a73e8", bg = "#e3f2fd") => {
            const el = document.getElementById("successMessage");
            el.textContent = msg;
            el.style.display = "block";
            el.style.backgroundColor = bg;
            el.style.color = color;
        };

        const showError = (msg) => {
            const el = document.getElementById("errorMessage");
            el.textContent = msg;
            el.style.display = "block";
            setTimeout(() => (el.style.display = "none"), 4000);
        };

        const hideMessages = () => {
            document.getElementById("errorMessage").style.display = "none";
            document.getElementById("successMessage").style.display = "none";
        };

        // ðŸ”¹ Register user in Firestore via backend
        const registerUser = async (user) => {
            try {
                showMessage("Saving your account details...");
                const response = await fetch("https://accomitra-backend-726841594875.asia-south1.run.app/api/users/register", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        uid: user.uid,
                        name: user.displayName || "Unnamed User",
                        email: user.email,
                    }),
                });

                if (!response.ok) throw new Error("Failed to register user in backend");

                console.log("âœ… User successfully registered in Firestore:", user.email);
                showMessage("Account created successfully! Redirecting...", "#2e7d32", "#e8f5e9");

                // Wait 1 second before redirecting
                setTimeout(() => {
                    window.location.href = "marketplace.html";
                }, 1000);
            } catch (err) {
                console.error("âŒ Error registering user:", err);
                showError("Something went wrong. Please try again.");
            }
        };

        // ðŸ”¹ Email Signup
        document.getElementById("emailSignupForm").addEventListener("submit", async (e) => {
            e.preventDefault();
            hideMessages();

            const name = document.getElementById("signupName").value;
            const email = document.getElementById("signupEmail").value;
            const password = document.getElementById("signupPassword").value;
            const confirmPassword = document.getElementById("confirmPassword").value;

            if (password !== confirmPassword) return showError("Passwords do not match!");

            try {
                showMessage("Creating your account...");
                const cred = await createUserWithEmailAndPassword(auth, email, password);
                await updateProfile(cred.user, { displayName: name });
                await registerUser(cred.user); // waits until Firestore registration finishes
            } catch (err) {
                console.error("Signup Error:", err);
                showError(err.message);
            }
        });

        // ðŸ”¹ Google Signup
        document.getElementById("googleSignup").addEventListener("click", async () => {
            hideMessages();
            try {
                showMessage("Signing up with Google...");
                const cred = await signInWithPopup(auth, provider);
                await registerUser(cred.user);
            } catch (err) {
                console.error("Google Signup Error:", err);
                showError(err.message);
            }
        });
    </script>

</body>

</html>