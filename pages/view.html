<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>AccoMitra | Accountant Details</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background: #f4f6ff;
      margin: 0;
      padding: 0;
    }
    header {
      background: #2a2a72;
      color: white;
      padding: 1rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .container {
      max-width: 800px;
      margin: 2rem auto;
      background: white;
      padding: 2rem;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    }
    h2 { color: #2a2a72; margin-bottom: 1rem; }
    .info-row {
      margin-bottom: 10px;
    }
    .info-label {
      font-weight: 600;
      color: #333;
    }
    .docs a {
      display: block;
      color: #2a2a72;
      text-decoration: none;
      margin-top: 5px;
    }
    button {
      padding: 10px 16px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      color: white;
      font-weight: 500;
      margin-right: 10px;
    }
    .approve-btn { background: #2e7d32; }
    .reject-btn { background: #c62828; }
    .back-btn { background: #1976d2; }
  </style>
</head>
<body>
  <header>
    <h2>Accountant Details</h2>
    <button class="back-btn" onclick="window.location.href='admin-dashboard.html'">← Back</button>
  </header>

  <div class="container" id="accountantDetails">
    <p>Loading details...</p>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      signOut
    } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
    import {
      getFirestore,
      doc,
      getDoc,
      updateDoc
    } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyD5Rda8GzjQhbegWPcT6Q-atfbmpb6enc4",
      authDomain: "accomitra-477605.firebaseapp.com",
      projectId: "accomitra-477605",
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const ALLOWED_ADMINS = [
      "ashwanthrkumar@gmail.com",
      "accomitra.admin@gmail.com"
    ];

    const container = document.getElementById("accountantDetails");

    // Get ID from URL
    // Get ID from URL
const urlParams = new URLSearchParams(window.location.search);
const accountantId = urlParams.get("id");

// ✅ Defensive check for missing ID
if (!accountantId) {
  alert("❌ No accountant ID provided in the URL.");
  window.location.href = "admin-dashboard.html";
  throw new Error("Missing accountant ID");
}


    // Auth check
    onAuthStateChanged(auth, async (user) => {
      if (!user || !ALLOWED_ADMINS.includes(user.email)) {
        alert("Unauthorized access!");
        window.location.href = "admin-login.html";
      } else {
        loadAccountant();
      }
    });

    // Load accountant details
    async function loadAccountant() {
      const docRef = doc(db, "accountants", accountantId);
      const docSnap = await getDoc(docRef);

      if (!docSnap.exists()) {
        container.innerHTML = "<p>Accountant not found.</p>";
        return;
      }

      const acc = docSnap.data();
      renderDetails(acc);
    }

    // Render accountant details
    function renderDetails(acc) {
      container.innerHTML = `
        <div class="info-row"><span class="info-label">Name:</span> ${acc.name}</div>
        <div class="info-row"><span class="info-label">Email:</span> ${acc.email}</div>
        <div class="info-row"><span class="info-label">Phone:</span> ${acc.phone}</div>
        <div class="info-row"><span class="info-label">Firm:</span> ${acc.firm_name}</div>
        <div class="info-row"><span class="info-label">Type:</span> ${acc.registrationType}</div>
        <div class="info-row"><span class="info-label">Experience:</span> ${acc.experience} years</div>
        <div class="info-row"><span class="info-label">Specialization:</span> ${acc.specialization}</div>
        <div class="info-row"><span class="info-label">Status:</span> <b>${acc.status}</b></div>
        ${
          acc.rejectionReason
            ? `<div class="info-row"><span class="info-label">Rejection Reason:</span> ${acc.rejectionReason}</div>`
            : ""
        }

        <div class="info-row docs">
          <span class="info-label">Documents:</span>
          ${Object.entries(acc.documents || {})
            .map(([key, path]) => `<a href="https://storage.googleapis.com/accomitra-accountant-files/${path}" target="_blank">${key}</a>`)
            .join("")}
        </div>

        ${
          acc.status === "pending"
            ? `
              <div style="margin-top: 20px;">
                <button class="approve-btn" id="approveBtn">Approve</button>
                <button class="reject-btn" id="rejectBtn">Reject</button>
              </div>
            `
            : ""
        }
      `;

      if (acc.status === "pending") {
        document.getElementById("approveBtn").addEventListener("click", () => approveAccountant(acc));
        document.getElementById("rejectBtn").addEventListener("click", () => rejectAccountant(acc));
      }
    }

    // Approve
    async function approveAccountant(acc) {
      await updateDoc(doc(db, "accountants", accountantId), { status: "approved" });
      alert("✅ Accountant approved!");
      window.location.href = "admin-dashboard.html";
    }

    // Reject with reason
    async function rejectAccountant(acc) {
      const reason = prompt("Enter rejection reason:");
      if (!reason) return;
      await updateDoc(doc(db, "accountants", accountantId), {
        status: "rejected",
        rejectionReason: reason,
      });
      alert("❌ Accountant rejected!");
      window.location.href = "admin-dashboard.html";
    }
  </script>
</body>
</html>
